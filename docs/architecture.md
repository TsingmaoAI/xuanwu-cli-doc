# 架构设计

玄武的系统设计和技术架构。

## 系统架构

玄武采用分层模块化架构：

```
┌──────────────────────────────────────┐
│     用户界面层                        │
│  CLI (xw) / API (/v1/chat/*)         │
├──────────────────────────────────────┤
│     调度与管理层                      │
│  模型加载/卸载/路由/资源管理          │
├──────────────────────────────────────┤
│     推理引擎层                        │
│  ┌──────────┐ ┌─────────┐ ┌────────┐ │
│  │MLGuider  │ │ MindIE  │ │  vLLM  │ │
│  │(深度优化)│ │(华为)   │ │(社区)  │ │
│  └──────────┘ └─────────┘ └────────┘ │
├──────────────────────────────────────┤
│     硬件抽象层                        │
│  驱动接口 / 内存管理 / 通信库         │
├──────────────────────────────────────┤
│     硬件层                            │
│  昇腾 / 沐曦 / ...               │
└──────────────────────────────────────┘
```

## 核心特性

### 多引擎架构

玄武的核心创新是支持多个推理引擎，根据模型和硬件自动选择最优后端。

**引擎隔离**

每个引擎运行在独立子进程中，通过 IPC 通信：

- **崩溃隔离** - 单个引擎故障不影响系统
- **依赖解耦** - 避免库版本冲突
- **资源效率** - 未使用的引擎不占用资源

**自动路由**

调度器根据以下规则选择引擎：

1. 查询模型 Registry，获取该模型在当前硬件的默认引擎
2. 检查引擎是否可用
3. 如果用户通过 `--engine` 指定引擎，验证兼容性后使用
4. 如果模型不支持当前硬件，拒绝请求

### 推理请求流程

```
用户请求
   ↓
API 服务器
   ↓
调度器
   ↓
选择/加载引擎
   ↓
权重加载 (如需张量并行，切分权重)
   ↓
推理计算
   ↓
流式/批量返回结果
   ↓
用户收到响应
```

### 模型加载优化

- **懒加载** - 模型仅在首次请求时加载，避免启动等待
- **服务器专项优化** - 多卡多实例支持，服务隔离

## 存储结构

```
~/.xuanwu/
├── models/
│   ├── {namespace}/
│   │   └── {model_name}/
│   │       ├── config.json
│   │       ├── model-*.safetensors
│   │       └── tokenizer.json
├── cache/
│   └── downloads/
└── logs/
    ├── xuanwu.log
    └── engines/
```

## 版本管理

模型支持语义化版本标签：

```
Qwen/Qwen3-8B:latest      # 最新版本
Qwen/Qwen3-8B:fp16        # 精度变体
```

## 备份与恢复

所有数据集中在 `XUANWU_HOME`：

```bash
# 备份
tar -czf xuanwu-backup.tar.gz ~/.xuanwu/

# 恢复
tar -xzf xuanwu-backup.tar.gz -C ~/
```

## 设计特点

- **轻量快捷** - 10MB 包体，Golang 开发
- **低门槛** - 简单易用的 CLI
- **国产原生** - 深度适配国产硬件
